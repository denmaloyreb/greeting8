package main

import (
	"bytes"
	"context"
	"encoding/json"
	"fmt"
	"log"
	"net/http"
	"os"
	"os/signal"
	"syscall"
	"time"

	"github.com/graphql-go/graphql"
	"github.com/graphql-go/handler"
)

// ะกะฟะธัะพะบ ะฟะพะทะดัะฐะฒะปะตะฝะธะน (ะธะฝะดะตะบั 0 ัะพะพัะฒะตัััะฒัะตั birth_day 1 ะธ ั.ะด.)
var greetings = []string{
	"ะก 8 ะะฐััะฐ! ะัััั ะบะฐะถะดัะน ะดะตะฝั ะดะฐัะธั ัะปัะฑะบะธ, ัะฐะดะพััั ะธ ะฒะดะพัะฝะพะฒะตะฝะธะต!",
	"ะะพะทะดัะฐะฒะปัั ั ะะตะถะดัะฝะฐัะพะดะฝัะผ ะถะตะฝัะบะธะผ ะดะฝัะผ! ะะตะปะฐั ะฒะตัะตะฝะฝะตะณะพ ะฝะฐัััะพะตะฝะธั, ะปัะฑะฒะธ ะธ ััะฐัััั!",
	"ะก 8 ะะฐััะฐ! ะััะฐะฒะฐะนัะตัั ัะฐะบะพะน ะถะต ะฟัะตะบัะฐัะฝะพะน, ะฝะตะถะฝะพะน ะธ ัะดะธะฒะธัะตะปัะฝะพะน!",
	"ะัััั ะฒ ััะพั ะดะตะฝั ัะฑัะดัััั ัะฐะผัะต ะทะฐะฒะตัะฝัะต ะผะตััั. ะก ะฟัะฐะทะดะฝะธะบะพะผ ะฒะตัะฝั!",
	"ะก 8 ะะฐััะฐ! ะะตะปะฐั ะผะพัะต ัะฒะตัะพะฒ, ัะตะฟะปะฐ, ัััะฐ ะธ ะฟัะธััะฝัั ัััะฟัะธะทะพะฒ!",
	"ะะพะทะดัะฐะฒะปัั ั 8 ะะฐััะฐ! ะัะดััะต ััะฐััะปะธะฒั, ะปัะฑะธะผั ะธ ะฝะตะฟะพะฒัะพัะธะผั!",
	"ะก ะะตะถะดัะฝะฐัะพะดะฝัะผ ะถะตะฝัะบะธะผ ะดะฝัะผ! ะัััั ะฒะตัะฝะฐ ัะฐััะฒะตัะฐะตั ะฒ ะดััะต, ะฐ ัะตัะดัะต ัะพะณัะตะฒะฐะตั ะปัะฑะพะฒั.",
	"ะก 8 ะะฐััะฐ! ะะตะปะฐั, ััะพะฑั ะบะฐะถะดัะน ะดะตะฝั ะฑัะป ัะฐะบะธะผ ะถะต ััะบะธะผ ะธ ะฟัะตะบัะฐัะฝัะผ, ะบะฐะบ ะฟะตัะฒัะต ะฒะตัะตะฝะฝะธะต ัะฒะตัั.",
	"ะะพะทะดัะฐะฒะปัั ั ะฟัะฐะทะดะฝะธะบะพะผ! ะัััั ะถะธะทะฝั ะธะณัะฐะตั ััะบะธะผะธ ะบัะฐัะบะฐะผะธ, ะฐ ััะดะพะผ ะฑัะดัั ัะพะปัะบะพ ะฒะตัะฝัะต ะธ ะปัะฑััะธะต ะปัะดะธ.",
	"ะก 8 ะะฐััะฐ! ะะตะปะฐั ััะฐัััั, ะบัะตะฟะบะพะณะพ ะทะดะพัะพะฒัั ะธ ะธัะฟะพะปะฝะตะฝะธั ะถะตะปะฐะฝะธะน!",
	// ะะพะฑะฐะฒะปะตะฝะฝัะต ะฟะพะทะดัะฐะฒะปะตะฝะธั (11โ20)
	"ะก 8 ะะฐััะฐ! ะัััั ะฒ ะฒะฐัะตะน ะดััะต ะฒัะตะณะดะฐ ัะฒะตััั ะฒะตัะฝะฐ!",
	"ะะพะทะดัะฐะฒะปัั c 8 ะะฐััะฐ! ะกะธัะนัะต, ะบะฐะบ ะฒะตัะตะฝะฝะตะต ัะพะปะฝัะต!",
	"ะก ะฟัะฐะทะดะฝะธะบะพะผ ะฒะตัะฝั, ะปัะฑะฒะธ ะธ ะบัะฐัะพัั! ะัะดััะต ััะฐััะปะธะฒั!",
	"ะก 8 ะะฐััะฐ! ะะตะปะฐั ะฝะตะถะฝะพััะธ, ัะตะฟะปะฐ ะธ ะฟัะธััะฝัั ัััะฟัะธะทะพะฒ ะบะฐะถะดัะน ะดะตะฝั!",
	"ะัััั ััะพั ะดะตะฝั ะฟะพะดะฐัะธั ะฒะฐะผ ะผะพัะต ัะปัะฑะพะบ ะธ ัะฒะตัะพะฒ. ะก 8 ะะฐััะฐ!",
	"ะก 8 ะะฐััะฐ! ะััะฐะฒะฐะนัะตัั ะฒัะตะณะดะฐ ัะฐะบะพะน ะถะต ะฟัะตะบัะฐัะฝะพะน ะธ ะฒะดะพัะฝะพะฒะปัััะตะน!",
	"ะะพะทะดัะฐะฒะปัั ั ะะตะถะดัะฝะฐัะพะดะฝัะผ ะถะตะฝัะบะธะผ ะดะฝัะผ! ะัััั ัะฑัะฒะฐัััั ะผะตััั!",
	"ะก 8 ะะฐััะฐ! ะะตะปะฐั ัะฐะดะพััะธ, ะฒะตัะตะฝะฝะตะณะพ ัะตะฟะปะฐ ะธ ััะฐัััั!",
	"ะก ะฟัะฐะทะดะฝะธะบะพะผ! ะัััั ะถะธะทะฝั ะฑัะดะตั ะฝะฐะฟะพะปะฝะตะฝะฐ ะปัะฑะพะฒัั ะธ ะณะฐัะผะพะฝะธะตะน.",
	"ะก 8 ะะฐััะฐ! ะะตะปะฐั, ััะพะฑั ะบะฐะถะดัะน ะดะตะฝั ะฟัะธะฝะพัะธะป ัะพะปัะบะพ ะฟัะธััะฝัะต ัะผะพัะธะธ!",
	// ะะพะฑะฐะฒะปะตะฝะฝัะต ะฟะพะทะดัะฐะฒะปะตะฝะธั (21โ32)
	"ะก 8 ะะฐััะฐ! ะัััั ะฒะฐัะฐ ะบัะฐัะพัะฐ ัะฐััะฒะตัะฐะตั ั ะบะฐะถะดัะผ ะดะฝัะผ!",
	"ะะพะทะดัะฐะฒะปัั ั ะฟัะฐะทะดะฝะธะบะพะผ ะฒะตัะฝั! ะะตะปะฐั ะฒะดะพัะฝะพะฒะตะฝะธั ะธ ะฝะพะฒัั ัะฒะตััะตะฝะธะน!",
	"ะก 8 ะะฐััะฐ! ะัััั ะฒ ัะตัะดัะต ะถะธะฒัั ะปัะฑะพะฒั, ะฐ ะฒ ะดะพะผะต โ ััั ะธ ัะตะฟะปะพ!",
	"ะก ะะตะถะดัะฝะฐัะพะดะฝัะผ ะถะตะฝัะบะธะผ ะดะฝัะผ! ะะตะปะฐั ััะบะธั ะบัะฐัะพะบ ะฒ ะถะธะทะฝะธ!",
	"ะก 8 ะะฐััะฐ! ะัะดััะต ะปัะฑะธะผั ะธ ััะฐััะปะธะฒั ะบะฐะถะดัะน ะผะธะณ!",
	"ะะพะทะดัะฐะฒะปัั! ะัััั ะฒะตัะฝะฐ ะฟะพะดะฐัะธั ะฒะฐะผ ะผะฝะพะณะพ ะฟะพะฒะพะดะพะฒ ะดะปั ัะปัะฑะพะบ!",
	"ะก 8 ะะฐััะฐ! ะะตะปะฐั, ััะพะฑั ะฒัะต ะฒะฐัะธ ะถะตะปะฐะฝะธั ะธัะฟะพะปะฝัะปะธัั ะปะตะณะบะพ ะธ ะฑััััะพ!",
	"ะก 8 ะะฐััะฐ! ะััะฐะฒะฐะนัะตัั ะบะพัะพะปะตะฒะพะน ัะฒะพะตะณะพ ััะฐัััั!",
	"ะก 8 ะะฐััะฐ! ะัััั ะฒะพะบััะณ ะฑัะดะตั ัะพะปัะบะพ ะดะพะฑัะพัะฐ, ะทะฐะฑะพัะฐ ะธ ะฒะฝะธะผะฐะฝะธะต!",
	"ะะพะทะดัะฐะฒะปัั ั ะะตะถะดัะฝะฐัะพะดะฝัะผ ะถะตะฝัะบะธะผ ะดะฝัะผ! ะะตะปะฐั ะผะพัะต ะฟะพะทะธัะธะฒะฐ!",
	"ะก 8 ะะฐััะฐ! ะัััั ะบะฐะถะดัะน ะดะตะฝั ะฑัะดะตั ะฝะฐะฟะพะปะฝะตะฝ ะปัะฑะพะฒัั ะธ ะณะฐัะผะพะฝะธะตะน!",
}

// ะกะฟะธัะพะบ ัะฒะตัะพะฒ ะดะปั ะบะฐะถะดะพะณะพ birth_day (ัะผะพะดะทะธ)
var flowers = []string{
	"๐ท๐น๐ธ", "๐ผ๐ป๐บ", "๐ท๐ท๐ท", "๐ธ๐ธ๐ธ", "๐น๐น๐น",
	"๐บ๐บ๐บ", "๐ป๐ป๐ป", "๐ผ๐ผ๐ผ", "๐ท๐น๐บ", "๐ธ๐ผ๐ป",
	"๐๐ท๐น", "๐ธ๐ผ๐ท", "๐ป๐บ๐ผ", "๐น๐ท๐ธ", "๐ผ๐ธ๐บ",
	"๐ท๐ป๐น", "๐ธ๐บ๐ผ", "๐น๐ผ๐ป", "๐บ๐ธ๐ท", "๐ป๐น๐ธ",
	"๐๐๐", "๐ท๐ท๐น", "๐ธ๐ธ๐ผ", "๐น๐น๐บ", "๐บ๐บ๐ป",
	"๐ป๐ป๐ผ", "๐ผ๐ผ๐ธ", "๐ท๐น๐ผ", "๐ธ๐ป๐บ", "๐น๐บ๐ท",
	"๐ผ๐ท๐ป",
}

// ะกัััะบัััะฐ, ะฟัะตะดััะฐะฒะปัััะฐั ะพัะฒะตั ั ะฟะพะทะดัะฐะฒะปะตะฝะธะตะผ ะธ ัะฒะตัะฐะผะธ
type GreetingResponse struct {
	Text    string `json:"text"`
	Flowers string `json:"flowers"`
}

func main() {
	// 1. ะะฟัะตะดะตะปัะตะผ ะพะฑัะตะบัะฝัะน ัะธะฟ Greeting
	greetingType := graphql.NewObject(graphql.ObjectConfig{
		Name: "Greeting",
		Fields: graphql.Fields{
			"text": &graphql.Field{
				Type: graphql.NewNonNull(graphql.String),
			},
			"flowers": &graphql.Field{
				Type: graphql.NewNonNull(graphql.String),
			},
		},
	})

	// 2. ะะพะปะต greeting ะฒ ะบะพัะฝะตะฒะพะผ ะทะฐะฟัะพัะต
	greetingField := &graphql.Field{
		Type: greetingType,
		Args: graphql.FieldConfigArgument{
			"birth_day": &graphql.ArgumentConfig{
				Type: graphql.NewNonNull(graphql.Int),
			},
		},
		Resolve: func(p graphql.ResolveParams) (interface{}, error) {
			birth_day, ok := p.Args["birth_day"].(int)
			if !ok {
				return nil, fmt.Errorf("birth_day ะดะพะปะถะตะฝ ะฑััั ัะตะปัะผ ัะธัะปะพะผ")
			}
			if birth_day < 1 || birth_day > len(greetings) {
				return nil, fmt.Errorf("ะฟะพะทะดัะฐะฒะปะตะฝะธะต ะดะปั birth_day %d ะฝะต ะฝะฐะนะดะตะฝะพ", birth_day)
			}
			// ะะฝะดะตะบัะฐัะธั ั 0
			return GreetingResponse{
				Text:    greetings[birth_day-1],
				Flowers: flowers[birth_day-1],
			}, nil
		},
	}

	rootQuery := graphql.NewObject(graphql.ObjectConfig{
		Name: "Query",
		Fields: graphql.Fields{
			"greeting": greetingField,
		},
	})

	schemaConfig := graphql.SchemaConfig{Query: rootQuery}
	schema, err := graphql.NewSchema(schemaConfig)
	if err != nil {
		log.Fatalf("ะพัะธะฑะบะฐ ัะพะทะดะฐะฝะธั ััะตะผั GraphQL: %v", err)
	}

	// 3. ะกะพะทะดะฐัะผ HTTP-ะพะฑัะฐะฑะพััะธะบ ั ะฒะบะปัััะฝะฝัะผ GraphiQL
	graphqlHandler := handler.New(&handler.Config{
		Schema:   &schema,
		Pretty:   true,
		GraphiQL: true,
	})

	// 4. ะะฟัะตะดะตะปัะตะผ ะฟะพัั ะธะท ะพะบััะถะตะฝะธั ะธะปะธ ะธัะฟะพะปัะทัะตะผ 8080 ะฟะพ ัะผะพะปัะฐะฝะธั
	port := os.Getenv("PORT")
	if port == "" {
		port = "8080"
	}

	server := &http.Server{Addr: ":" + port, Handler: graphqlHandler}
	go func() {
		log.Printf("GraphQL ัะตัะฒะตั ะทะฐะฟััะตะฝ ะฝะฐ http://localhost:%s", port)
		log.Printf("GraphiQL ะธะฝัะตััะตะนั ะดะพัััะฟะตะฝ ะฟะพ ะฐะดัะตัั http://localhost:%s", port)
		if err := server.ListenAndServe(); err != nil && err != http.ErrServerClosed {
			log.Fatalf("ะพัะธะฑะบะฐ ะทะฐะฟััะบะฐ ัะตัะฒะตัะฐ: %v", err)
		}
	}()

	// 5. ะะถะธะดะฐะฝะธะต ัะธะณะฝะฐะปะฐ ะทะฐะฒะตััะตะฝะธั
	stop := make(chan os.Signal, 1)
	signal.Notify(stop, os.Interrupt, syscall.SIGTERM)

	// 6. CLI-ะฒะทะฐะธะผะพะดะตะนััะฒะธะต
	fmt.Println("ะะฒะตะดะธัะต birth_day (ะพั 1 ะดะพ 31) ะดะปั ะฟะพะปััะตะฝะธั ัะตะบััะฐ ะธ ัะฒะตัะพะฒ. ะะปั ะฒััะพะดะฐ ะฒะฒะตะดะธัะต 'exit' ะธะปะธ ะฝะฐะถะผะธัะต Ctrl+C.")
	for {
		fmt.Print("birth_day: ")
		var input string
		_, err := fmt.Scanln(&input)
		if err != nil {
			fmt.Println("ะัะธะฑะบะฐ ะฒะฒะพะดะฐ, ะฟะพะฟัะพะฑัะนัะต ัะฝะพะฒะฐ")
			continue
		}
		if input == "exit" {
			fmt.Println("ะะฐะฒะตััะตะฝะธะต ัะฐะฑะพัั.")
			break
		}

		var birth_day int
		_, err = fmt.Sscan(input, &birth_day)
		if err != nil {
			fmt.Println("ะะพะถะฐะปัะนััะฐ, ะฒะฒะตะดะธัะต ัะธัะปะพ ะพั 1 ะดะพ 10")
			continue
		}

		// ะคะพัะผะธััะตะผ GraphQL-ะทะฐะฟัะพั (ัะตะฟะตัั ะทะฐะฟัะฐัะธะฒะฐะตะผ ะพะฑะฐ ะฟะพะปั)
		query := fmt.Sprintf(`{"query": "query { greeting(birth_day: %d) { text flowers } }"}`, birth_day)
		body := bytes.NewBufferString(query)

		resp, err := http.Post(fmt.Sprintf("http://localhost:%s/", port), "application/json", body)
		if err != nil {
			log.Printf("ะัะธะฑะบะฐ ะฟัะธ ะพัะฟัะฐะฒะบะต ะทะฐะฟัะพัะฐ: %v", err)
			continue
		}
		defer resp.Body.Close()

		var result struct {
			Data struct {
				Greeting struct {
					Text    string `json:"text"`
					Flowers string `json:"flowers"`
				} `json:"greeting"`
			} `json:"data"`
			Errors []struct {
				Message string `json:"message"`
			} `json:"errors"`
		}
		if err := json.NewDecoder(resp.Body).Decode(&result); err != nil {
			log.Printf("ะัะธะฑะบะฐ ะดะตะบะพะดะธัะพะฒะฐะฝะธั ะพัะฒะตัะฐ: %v", err)
			continue
		}

		if len(result.Errors) > 0 {
			fmt.Printf("ะัะธะฑะบะฐ ะพั ัะตัะฒะตัะฐ: %s\n", result.Errors[0].Message)
		} else {
			fmt.Printf("ะะพะทะดัะฐะฒะปะตะฝะธะต: %s\n", result.Data.Greeting.Text)
			fmt.Printf("ะฆะฒะตัั: %s\n\n", result.Data.Greeting.Flowers)
		}
	}

	// 7. Graceful shutdown
	fmt.Println("ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ัะตัะฒะตั...")
	ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)
	defer cancel()
	if err := server.Shutdown(ctx); err != nil {
		log.Fatalf("ะัะธะฑะบะฐ ะฟัะธ ะพััะฐะฝะพะฒะบะต ัะตัะฒะตัะฐ: %v", err)
	}
	fmt.Println("ะกะตัะฒะตั ะพััะฐะฝะพะฒะปะตะฝ.")
}
